-- Class for monitor interface

local function btn_callback(button)
    if (button.label == "Blocks") then
        link.send_command(link.ids.smeltery, 1)
        button.toggle_color()
    elseif (button.label == "Ingots") then
        link.send_command(link.ids.smeltery, 0)
        button.toggle_color()
    elseif (button.label == "Rods") then
        link.send_command(link.ids.smeltery, 2)
        button.toggle_color()
    elseif (button.label == "Wires") then
        link.send_command(link.ids.smeltery, 3)
        button.toggle_color()
    elseif (button.label == "Plates") then
        link.send_command(link.ids.smeltery, 4)
        button.toggle_color()

    end
end

function Interface()
    local interface = {}
    -- Initialise variables
    local display = peripheral.wrap(config.monitor)
    interface.buttons = {}
    interface.tanks_displayed = 0
    interface.views = {"smeltery", "reactor", "lighting", "turtle"}
    interface.views_index = 1
    interface.reactor_data = nil
    interface.miner_data = nil

    -- Initialise the view
    display.setBackgroundColor(colors.black)
    display.setTextScale(.5)
    display.clear()
    interface.buttons.blocks = button_class.Button("Blocks", 2, 2, display)
    interface.buttons.ingots = button_class.Button("Ingots", 2, 4, display)
    interface.buttons.rods = button_class.Button("Rods", 2, 6, display)
    interface.buttons.wires = button_class.Button("Wires", 2, 8, display)
    interface.buttons.plates = button_class.Button("Plates", 2, 10, display)
    interface.buttons.react_power = button_class.Button("On", 20, 2, display)
    interface.buttons.cycle_left = button_class.Button("<", 44, 18, display)
    interface.buttons.cycle_right = button_class.Button(">", 48, 18, display)

    function interface.show_view(view)
        if view == "smeltery" then
            interface.display.clear()
            interface.buttons.blocks.set_color(colors.orange)
            interface.buttons.ingots.set_color(colors.orange)
            interface.buttons.rods.set_color(colors.orange)
            interface.buttons.wires.set_color(colors.orange)
            interface.buttons.plates.set_color(colors.orange)
        elseif view == "reactor" then
            display.clear()
            interface.set_title("Reactor")
            if interface.reactor_data ~= nil then
                interface.update_reactor_stats(interface.reactor_data)
            end
        elseif view == "lighting" then
            display.clear()
            interface.set_title("Lighting menu")
        elseif view == "turtle" then
            display.clear()
            interface.set_title("Mining turtle")
            if interface.miner_data ~= nil then
                interface.update_miner_stats(interface.miner_data)
            end
        end
        interface.buttons.cycle_left.set_color(colors.lightGray)
        interface.buttons.cycle_right.set_color(colors.lightGray)
    end

    function interface.show_smeltery_levels(tanks)
        for i=1, interface.tanks_displayed do
            display.setCursorPos(20, i+1)
            display.write("                      ")
        end
        local max = 0
        for i, tank in pairs(tanks) do
            display.setCursorPos(20, i+1)
            display.write(tank[1] .. ": " .. tank[2] .. " ingots")
            max = i
        end
        interface.tanks_displayed = max+1
    end

    function interface.update_reactor_stats(reactor)
        interface.reactor_data = reactor
        display.setCursorPos(2, 3)
        display.write("Energy: "..reactor.energy)
        display.setCursorPos(2, 4)
        display.write("Stored: "..reactor.stored_energy)
        display.setCursorPos(2, 5)
        display.write("Fuel level: "..reactor.fuel_level)
        display.setCursorPos(2, 6)
        display.write("Fuel consumption: "..reactor.fuel_consumption)
        display.setCursorPos(2, 7)
        display.write("Fuel reactivity: "..reactor.fuel_reactivity)
        display.setCursorPos(2, 8)
        display.write("Controlrod level: "..reactor.control_rod)
        display.setCursorPos(2, 9)
        display.write("Fuel temperature: "..reactor.fuel_temp)
        display.setCursorPos(2, 10)
        display.write("Case temperature: "..reactor.casing_temp)
        if reactor.active then
            interface.buttons.react_power.label = "On"
            interface.buttons.react_power.bg_color = colors.green
        else
            interface.buttons.react_power.label = "Off"
            interface.buttons.react_power.bg_color = colors.orange
        end
        interface.buttons.react_power.draw()
    end

    function interface.update_miner_stats(miner)
        interface.miner_data = miner
        display.setCursorPos(2, 4)
        display.write("Fuel level "..miner.fuel.." blocks.")
        display.setCursorPos(2, 5)
        display.write("Distance home "..miner.dist_home)
        display.setCursorPos(2, 6)
        display.write("Gps "..miner.gps[1].."x "..miner.gps[2].."y "..miner.gps[3].."z")
        local max = math.max(unpack(miner.map))
        local scale = max/7
        display.setCursorPos(42, 2)
        display.write("Scale "..scale)
        display.setBackgroundColor(colors.brown)
        for i, data in pairs(miner.map) do
            data = math.floor(data/scale)
            for j=1, data do
                if i == 1 then
                    display.setCursorPos(40, 9-j)
                elseif i == 2 then
                    display.setCursorPos(40+j, 9)
                elseif i == 3 then
                    display.setCursorPos(40, 9+j)
                elseif i == 4 then
                    display.setCursorPos(40-j, 9)
                end
                display.write(" ")
            end
        end
        display.setBackgroundColor(colors.white)
    end

    function interface.set_title(title)
        display.setCursorPos(1,1)
        display.write(title)
    end

    function interface.check_touch(pos_x, pos_y)
        for key, but in pairs(interface.buttons) do
            if but.check_touch(pos_x, pos_y) then
                if but.label == ">" then
                    interface.views_index = (interface.views_index + 1) % #interface.views
                    return interface.show_view(interface.views[interface.views_index+1])
                elseif but.label == "<" then
                    interface.views_index = math.abs((interface.views_index - 1) % #interface.views)
                    return interface.show_view(interface.views[interface.views_index+1])
                end
                if btn_callback ~= nil then
                    res = btn_callback(but)
                end
            end
        end
    end

    function interface.set_button_color(but_name, color)
        for i, buts in pairs(interface.buttons) do
            if buts.label == but_name then
                buts.set_color(color)
                return
            end
        end
    end

    return interface
end